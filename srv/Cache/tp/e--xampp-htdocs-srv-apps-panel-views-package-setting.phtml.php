<div class="page-header">
    <h1>
        <i class="fa fa-gear"></i> 基本设置
        <small>

        </small>
    </h1>
</div>
<style>
    .form-group {
        min-height: 30px;
        overflow: hidden;
    }

    .form-group input[type='number'] {
        width: 100px;
    }

    .form-group .control-label {
        text-align: right;
    }

    .form-group select {
        margin: 0;
    }

    .disabled {
        background-color: #e4e4e4;
        width: 100%;
        height: 100%;
        overflow: hidden;
    }

    .discuss_recommend_wrap, .share_wrap {
        padding-top: 10px;
        margin-bottom: 10px;
        width: 99%;
    }

    .disabled .form-group input {
        background-color: #f5f5f5;
    }

    .disabled .form-group input {
        background-color: #f5f5f5;
    }

    .minus_btn {
        box-sizing: content-box;
        width: 20px;
        height: 20px;
        float: left;
        text-align: center;
        overflow: hidden;
        display: inline-block;
        border: 1px solid #e4e4e4;
        border-radius: 100%;
        margin-right: 5px;
        margin-top: 5px;
        cursor: pointer;
    }

    .list .head {
        background-color: #f5f5f5;
    }
</style>
<main class="tab-content" style="border:none; ">
    <!--    <p class="alert alert-info"><i class="fa fa-tag"></i>-->
    <!--        1.关闭系统奖励后 所有奖励都将失效<br/>-->
    <!--        &nbsp; 2.金额单位为<b class="red">“分”</b><br/>-->
    <!---->
    <!--    </p>-->
    <section id="home" class="tab-pane in active">

        <div class="">
            <div class="share_wrap">
                <div class="form-group" style="">
                    <label for="logo" class="col-sm-2 control-label">每人每天上限:</label>
                    <div class="col-sm-9">
                        <input type="number" class="day_pick_limit" min="0"
                               value="<?php echo ($setting && !empty($setting['day_pick_limit'])) ? $setting['day_pick_limit'] : 0 ?>">
                        次
                    </div>
                </div>
                <div class="form-group" style="">
                    <label for="logo" class="col-sm-2 control-label">显示多大范围内:</label>
                    <div class="col-sm-9">
                        <input type="number" class="distance_limit" min="0"
                               value="<?php echo ($setting && !empty($setting['distance_limit'])) ? $setting['distance_limit'] : 0 ?>">
                        米
                    </div>
                </div>
                <div class="form-group" style="">
                    <label for="logo" class="col-sm-2 control-label">刷新红包的递增时间:</label>
                    <div class="col-sm-9">
                        <input type="number" class="increase_time" min="0"
                               value="<?php echo ($setting && !empty($setting['increase_time'])) ? $setting['increase_time'] : 0 ?>">
                        秒【例如为10秒,则红包刷新为0秒 10秒 20秒 30秒 40秒】
                    </div>
                </div>
                <div class="form-group" style="">
                    <label for="logo" class="col-sm-2 control-label">刷新红包多久重新计算:</label>
                    <div class="col-sm-9">
                        <input type="number" class="clear_time" min="0"
                               value="<?php echo ($setting && !empty($setting['clear_time'])) ? $setting['clear_time'] : 0 ?>">
                        分【例如为30分钟,则当上次领红包和这次相比如果大于30分钟则红刷新时间重新开始计算】
                    </div>
                </div>
                <div class="form-group" style="">
                    <label for="logo" class="col-sm-2 control-label">每天保持多少个机器人红包可用:</label>
                    <div class="col-sm-9">
                        <input type="number" class="keep_count" min="0"
                               value="<?php echo ($setting && !empty($setting['keep_count'])) ? $setting['keep_count'] : 0 ?>">
                        个【比如设为30 则今天机器人会保证今天发的红包一直有30个可用】
                    </div>
                </div>
                <div class="form-group" style="">
                    <label for="logo" class="col-sm-2 control-label">每天机器人红包总金额限制:</label>
                    <div class="col-sm-9">
                        <input type="number" class="money_limit" min="0"
                               value="<?php echo ($setting && !empty($setting['money_limit'])) ? $setting['money_limit'] : 0 ?>">
                        元【如果超出了预想金额，则不会再发机器人红包】
                    </div>
                </div>
                <div class="form-group" style="">
                    <label for="logo" class="col-sm-2 control-label">每个机器人红包最低金额:</label>
                    <div class="col-sm-9">
                        <input type="number" class="money_limit_one" min="0"
                               value="<?php echo ($setting && !empty($setting['money_limit_one'])) ? $setting['money_limit_one'] : 0 ?>">
                        分
                    </div>
                </div>
                <div class="form-group" style="">
                    <label for="logo" class="col-sm-2 control-label">广场显示红包总个数:</label>
                    <div class="col-sm-9">
                        <input type="number" class="total_package" min="0"
                               value="<?php echo ($setting && !empty($setting['total_package'])) ? $setting['total_package'] : 0 ?>">
                        个
                    </div>
                </div>
                <div class="form-group" style="">
                    <label for="logo" class="col-sm-2 control-label">领取达到上限显示的可用红包个数:</label>
                    <div class="col-sm-9">
                        <input type="number" class="limit_top_start" min="0"
                               value="<?php echo ($setting && !empty($setting['limit_top_start'])) ? $setting['limit_top_start'] : 0 ?>">
                        - <input type="number" class="limit_top_end" min="0"
                                 value="<?php echo ($setting && !empty($setting['limit_top_end'])) ? $setting['limit_top_end'] : 0 ?>">
                        个
                    </div>
                </div>
                <div class="form-group" style="">
                    <label for="logo" class="col-sm-2 control-label">领取未达上限显示的可用红包个数:</label>
                    <div class="col-sm-3">
                        <table class="list">
                            <tr class="head">
                                <th>个数</th>
                                <th>百分比%</th>
                            </tr>
                            <?php if ($setting['enable_limit']) { ?>
                                <?php foreach ($setting['enable_limit'] as $k => $item) {
                                    ?>
                                    <tr class="params_item">
                                        <td>
                                            <?php if ($k != 0) { ?>
                                                <span class="minus_btn" style=""><i
                                                        class="fa fa-minus"></i></span>
                                            <?php } ?>
                                            <input type="number" min="0" max="100" name="num[]" class="num"
                                                   value="<?php echo $item['num'] ?>"/></td>
                                        <td><input type="number" min="0" max="100" name="rate[]" class="rate"
                                                   value="<?php echo $item['rate'] ?>"/></td>
                                    </tr>
                                <?php } ?>
                            <?php } else { ?>
                                <tr class="params_item">
                                    <td><input type="number" min="0" max="100" name="num[]" class="num"
                                               value=""/>
                                    </td>
                                    <td><input type="number" min="0" max="100" name="rate[]" class="rate"
                                               value=""/>
                                    </td>
                                </tr>
                            <?php } ?>

                        </table>
                    </div>
                </div>
                <div class="form-group" style="">
                    <label for="logo" class="col-sm-2 control-label">允许发布范围:</label>
                    <div class="col-sm-9">
                        <label> <input type="checkbox"
                                       class="chk ace" <?php echo $setting['range_type'] && in_array(1, $setting['range_type']) ? 'checked' : '' ?>
                                       name="range_type" value="1"
                                       data-id="1"/><span class="lbl"></span></label> 全国&nbsp;
                        <label> <input type="checkbox"
                                       class="chk ace" <?php echo $setting['range_type'] && in_array(2, $setting['range_type']) ? 'checked' : '' ?>
                                       name="range_type" value="2"
                                       data-id="2"/><span class="lbl"></span></label> 全市&nbsp;
                        <label> <input type="checkbox"
                                       class="chk ace" <?php echo $setting['range_type'] && in_array(0, $setting['range_type']) ? 'checked' : '' ?>
                                       name="range_type" value="0"
                                       data-id="0"/><span class="lbl"></span></label> 附近2公里
                    </div>
                </div>

                <p class="alert alert-danger error-widget" style="display: none"><i class="fa fa-warning"></i>
                    <span class="error_msg"></span>
                </p>
            </div>

        </div>
        </div>
        <div
            style="width: 100%;height: auto;overflow: hidden;border: 1px solid #f4f4f4;padding:10px 0 0 0;border-top: none">
            <div class="form-group">
                <label for="name" class="col-sm-1 control-label"></label>

                <div class="col-sm-10" style="padding: 0 0 0 30px;">
                    <button type="submit" class="btn btn-primary btn-large btnSave" name="btn-base">
                        <i class="fa fa-paper-plane"></i>立即保存
                    </button>
                </div>
            </div>
        </div>
    </section>

</main>
<script>
    seajs.use('app/panel/panel.base', function (api) {

        $(".btnSave").on('click', function () {
            var day_pick_limit = $(".day_pick_limit").val();
            var distance_limit = $(".distance_limit").val();
            var increase_time = $(".increase_time").val();
            var clear_time = $(".clear_time").val();
            var keep_count = $(".keep_count").val();
            var money_limit = $(".money_limit").val();
            var money_limit_one = $(".money_limit_one").val();
            var total_package = $(".total_package").val();//显示总红包个数
            var limit_top_start = $(".limit_top_start").val();//领取达到上限时显示的可用红包个数起始值
            var limit_top_end = $(".limit_top_end").val();//领取达到上限时显示的可用红包个数结束值
            var enable_limit = []; //领取未达上限显示的红包个数及百分比
            $(".list").find(".params_item").each(function () {
                var num = $(this).find('.num').val();
                var rate = $(this).find('.rate').val();

                if (num != '' && rate != '') {
                    enable_limit.push({'num': num, 'rate': rate})
                }
            });
            var range_type = [];
            $("input[name='range_type']").each(function () {
                if ($(this).prop('checked') === true) {
                    range_type.push($(this).val());
                }
            });
            var data = {
                day_pick_limit: day_pick_limit,
                distance_limit: distance_limit,
                increase_time: increase_time,
                clear_time: clear_time,
                keep_count: keep_count,
                money_limit: money_limit,
                money_limit_one: money_limit_one,
                range_type: range_type,
                total_package: total_package,
                limit_top_start: limit_top_start,
                limit_top_end: limit_top_end,
                enable_limit: enable_limit
            };


            api.requestApi('/api/package/setting', data, function (res) {
                if (res.result == 1) {
                    tip.showTip("ok", '保存成功', 1000, function () {
                        window.location.reload();
                    });
                }
            })

        })
    });

    $(".list").on('keyup', '.rate', function (event) {
        if (event.keyCode == "13") {
            var html = $(this).closest("tr").clone();
            if ($(".list").find("tr").length == 2 || $(".minus_btn").length == 0) {
                html.find("td").eq(0).append('<span class="minus_btn" style=""><i class="fa fa-minus"></i></span>');
            }
            $(".list").append(html);
            html.find(".rate").focus();
        } else if (event.keyCode === 8) {
            if ($(".list").find("tr").length > 2) {
                if ($(this).val() == '' && $(this).closest("tr").find('.start').val() == '') {
                    $(this).closest("tr").prev().find('.rate').focus();
                    $(this).closest("tr").remove();
                }
            }

        }
    }).on("click", '.minus_btn', function () {
        if ($(".list").find("tr").length > 2) {
            $(this).closest("tr").remove();
        }
    });
    function error(msg) {
        tip.showTip("err", msg, 1000);
        $(".error-widget .error_msg").html(msg);
        $(".error-widget").show();
    }

</script>
