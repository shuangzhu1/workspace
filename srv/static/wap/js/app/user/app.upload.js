define(function(require,exports){var e="";var t={img:e+"/api/upload/img",file:e+"/api/upload/file",video:e+"/api/upload/video",audio:e+"/api/upload/audio"};var a={img:"jpg,png,gif,jpeg,bmp,ico",file:"zip,rar,doc,xls,ppt,docx,pptx,xlsx,txt",video:"mp4,3gp,ogg,webm,flv,f4v",audio:"mp3,m4a,ogg,spx,oga"};var i={img:"5mb",file:"20mb",video:"200mb",audio:"10mb"};var o={img:"0",file:"2kb",video:"100kb",audio:"1mb"};require("/static/panel/js/tools/plupload/plupload.min");function l(e,t){if(!e||!/image\//.test(e.type))return;if(e.type=="image/gif"){var a=new mOxie.FileReader;a.onload=function(){var e=a.result;t(e)};a.readAsDataURL(e.getSource())}else{var i=new mOxie.Image;i.onload=function(){var a=i.type=="image/jpeg"?i.getAsDataURL("image/jpeg",80):i.getAsDataURL();t&&t(a,e);i.destroy();i=null};i.load(e.getSource())}}exports.uploadAvatar=function(e,r,n,s){var p="";var d=r.type;var u=t[d];if(u==undefined){$(e+" .up_file_list").html("please choose type");return false}var m={video:"视频",audio:"音频",img:"图片",file:"文件"};$(e).each(function(){p=$(this).attr("data-unique");$(this).find(".browse-button").attr("id","browse_files_button_"+p);$(this).find(".drop_element").attr("id","upload_drop_element_"+p)});var f={type:"img",auto_upload:false,multi_selection:false,multipart_params:{},file_data_name:"file"};console.log(a[d]);f=$.extend({},f,r);var _=new plupload.Uploader({runtimes:"html5,flash",url:u,drop_element:"upload_drop_element_"+p,browse_button:"browse_files_button_"+p,file_data_name:f.file_data_name,multi_selection:f.multi_selection,dragdrop:true,unique_names:true,multipart:true,multipart_params:{session:app.sess},flash_swf_url:"/data/Moxie.swf",filters:{max_file_size:i[d],min_file_size:o[d],mime_types:[{title:"Files",extensions:a[d]}],prevent_duplicates:false},init:{PostInit:function(){var t="请选择"+m[d];if(f.multi_selection)t="按CTRL即可多选";$(e+" .up_file_list").html("<span>"+t+"</span>")},FilesAdded:function(e,t){$(".percent").html("");plupload.each(t,function(e){l(e,function(e){var t=new Image;t.src=e;var a=t.width;var i=t.height;$("#avatar").attr("src",e).attr("data-width",a).attr("data-height",i);$("#upload_btn").hide()})})},UploadProgress:function(e,t){if(parseInt(t.percent)!=100){$(".percent").html("%"+t.percent)}else{$(".percent").html("【正在上传至OSS...】")}var a=$("#msgModal");console.log(t.percent)},FileUploaded:function(e,t,a){var i=$.parseJSON(a.response);if(i.result==1){if(f.extra)i.data.extra=f.extra;if(typeof s=="function")s(i.data)}else{tip.showTip("err","上传失败",1e3)}},Error:function(e,t){tip.showTip("err",t.message,1e3);console.log(t.message)}}});_.init();n(_)}});