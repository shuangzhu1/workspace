(function($){window.inAjaxProcess=false;var e={init:function(t){return this.each(function(){if(t){$.extend(e.settings,t)}e.template=$(this).children(e.settings.template).wrap("<div/>").parent();e.template.css("display","none");$(this).append('<div class="more_loader_spinner">'+e.settings.spinner_code+"</div>");$(this).children(e.settings.template).remove();e.target=$(this);if(e.settings.scroll=="false"){console.log($(this).attr("class"));$(this).on("click",e.settings.trigger,e.get_data);$(this).more("get_data")}else{if($(this).height()<=$(this).attr("scrollHeight")){e.target.more("get_data",e.settings.amount*2)}$(this).on("scroll.more",e.check_scroll)}})},check_scroll:function(){if(e.target.scrollTop()+e.target.height()+parseInt(e.settings.offset)>=e.target.attr("scrollHeight")&&e.lock==false){e.target.more("get_data")}},debug:function(){var t="";$.each(e.variables,function(e,s){t+=e+" : "+s+"\n"});alert(t)},remove:function(){e.target.children(e.settings.trigger).unbind(".more");e.target.unbind(".more");e.target.children(e.settings.trigger).remove()},add_elements:function(t){var s=e.target;var a=0;if(t){$(".data_count").html(t["data"]["count"]);if($.trim(e.settings.params.key).length>0){$(".search_result").show().find(".search_key").html(this.settings.params.key)}else{$(".search_result").hide().find(".search_key").html("")}if(t["data"]["count"]==0&&e.variables.page==1){s.children(e.settings.trigger).before('<li class="noData">暂无数据</li>');window.scrollTo(0,0)}$(t["data"]["data_list"]).each(function(){a++;var t=e.template;$.each(this,function(e,s){t.html(s)});if(e.settings.scroll=="true"){s.children(".more_loader_spinner").before(t.html())}else{s.children(e.settings.trigger).before(t.html())}s.children(e.settings.template+":last").attr("id","more_element_"+(e.variables.last+++1))});e.variables.page++}else e.remove();e.target.children(".more_loader_spinner").css("display","none");if(a<e.settings.amount)e.remove();e.settings.callback()},get_data:function(){console.log(this);console.log(e.variables);console.log(e.settings);console.log(e.target);var t;e.lock=true;e.target.children(".more_loader_spinner").css("display","block");$(e.settings.trigger).css("display","none");if(typeof arguments[0]=="number")t=arguments[0];else{t=e.settings.amount}setTimeout(function(){var s;if(e.settings.params==""){s={page:e.variables.page,limit:t}}else{s=e.settings.params;s["page"]=e.variables.page;s["limit"]=e.settings.amount;e.variables.pre_page=e.variables.page}$.ajax({url:e.settings.address,data:s,type:"post",async:true,dataType:e.settings.format,success:function(t){$(e.settings.trigger).css("display","block");e.add_elements(t)},error:function(){},beforeSend:function(){if(window.inAjaxProcess){return false}window.inAjaxProcess=true},complete:function(){window.inAjaxProcess=false}})},200)}};e.target=null;e.template=null;e.lock=false;e.variables={last:1,page:1,pre_page:0};e.settings={amount:"10",address:"comments.php",params:"",format:"json",template:".single_item",trigger:".get_more",scroll:"false",offset:"100",spinner_code:"",callback:""};e.variables.last=e.variables.page=1;$.fn.more=function(t){if(e[t])return e[t].apply(this,Array.prototype.slice.call(arguments,1));else if(typeof t=="object"||!t){return e.init.apply(this,arguments)}else $.error("Method "+t+" does not exist!")}})(jQuery);