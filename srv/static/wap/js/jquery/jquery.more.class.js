var more=function(e,t){this.ele=e;this.target=null;this.template=null;this.lock=false;this.no_data=false;this.variables={last:1,page:1,pre_page:0,last_id:""};this.settings={amount:"10",address:"",params:"",format:"json",template:".single_item",trigger:".get_more",scroll:"false",offset:"100",spinner_code:"",callback:""};this.variables.last=this.variables.page=1;$.extend(this.settings,t)};more.prototype={init:function(){var e=this;e.template=$(e.ele).children(e.settings.template).wrap("<div/>").parent();e.template.css("display","none");$(e.ele).append('<div class="more_loader_spinner">'+e.settings.spinner_code+"</div>");$(e.ele).children(e.settings.template).remove();e.target=$(e.ele);if(e.settings.scroll=="false"){$(e.ele).on("click",e.settings.trigger,e.get_data);e.get_data()}else{if($(e.ele).height()<=$(e.ele).attr("scrollHeight")){e.get_data(e.settings.amount*2)}$(e.ele).on("scroll.more",e.check_scroll)}$(window).scroll(function(){if(!$(e.ele).is(":hidden")){if($(e.template).length>0){if($(window).scrollTop()==$(document).height()-$(window).height()){e.get_data(e.settings.amount*2)}}}})},check_scroll:function(){var e=this;if(e.target.scrollTop()+e.target.height()+parseInt(e.settings.offset)>=e.target.attr("scrollHeight")&&e.lock==false){e.target.more("get_data")}},debug:function(){var e=this;var t="";$.each(e.variables,function(e,a){t+=e+" : "+a+"\n"});alert(t)},remove:function(){var e=this;e.target.children(e.settings.trigger).unbind(".more");e.target.unbind(".more");e.target.children(e.settings.trigger).remove()},add_elements:function(e){var t=this;var a=t.target;var s=0;if(e){if(e["data"]["count"]==0&&t.variables.page==1){a.children(t.settings.trigger).before('<li class="noData">暂无数据</li>')}if(e["data"]["data_list"].length==0){t.target.children(".more_loader_spinner").hide()}else{$(e["data"]["data_list"]).each(function(){s++;var e=t.template;$.each(this,function(t,a){e.html(a)});if(t.settings.scroll=="true"){a.children(".more_loader_spinner").before(e.html())}else{a.children(t.settings.trigger).before(e.html())}a.children(t.settings.template+":last").attr("id","more_element_"+(t.variables.last+++1));t.variables.last++});t.variables.page++}if(e["data"]["last_id"]!==undefined)t.variables.last_id=e["data"]["last_id"]}else{t.remove()}t.target.children(".more_loader_spinner").hide();if(s<t.settings.amount){t.no_data=true}t.settings.callback()},get_data:function(){var e=this;if(!e.lock&&!e.no_data){var t;e.target.children(".more_loader_spinner").css("display","block");$(e.settings.trigger).css("display","none");if(typeof arguments[0]=="number")t=arguments[0];else{t=e.settings.amount}e.lock=true;setTimeout(function(){var a;if(e.settings.params==""){a={page:e.variables.page,limit:t}}else{a=e.settings.params;a["page"]=e.variables.page;a["limit"]=e.settings.amount;a["last_id"]=e.variables.last_id;e.variables.pre_page=e.variables.page}$.ajax({url:e.settings.address,data:a,type:"post",async:true,dataType:e.settings.format,success:function(t){$(e.settings.trigger).css("display","block");e.add_elements(t)},error:function(){},beforeSend:function(){if(window.inAjaxProcess){return false}window.inAjaxProcess=true},complete:function(){window.inAjaxProcess=false;e.lock=false}})},200)}}};$.fn.more=function(e){var t=new more(this,e);t.init()};