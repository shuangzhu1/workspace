/**
 * @file refresh
 * @import src/widget/refresh/refresh.js,src/widget/refresh/refresh.js,src/widget/refresh/$lite.js,src/widget/refresh/$iOS5.js,
 * @module GMU
 */

!function(a,b,c){a.define("Refresh",{options:{load:null,statechange:null},_init:function(){var a=this,c=a._options;a.on("ready",function(){b.each(["up","down"],function(b,d){var e=c["$"+d+"Elem"],f=e.get(0);e.length&&(a._status(d,!0),(!f.childNodes.length||e.find(".ui-refresh-icon").length&&e.find(".ui-refresh-label").length)&&(!f.childNodes.length&&a._createBtn(d),c.refreshInfo||(c.refreshInfo={}),c.refreshInfo[d]={$icon:e.find(".ui-refresh-icon"),$label:e.find(".ui-refresh-label"),text:e.find(".ui-refresh-label").html()}),e.on("click",function(){a._status(d)&&!c._actDir&&(a._setStyle(d,"loading"),a._loadingAction(d,"click"))}))})}),a.on("destroy",function(){a.$el.remove()})},_create:function(){var a=this,b=a._options,c=a.$el;a._options.setup&&(b.$upElem=c.find(".ui-refresh-up"),b.$downElem=c.find(".ui-refresh-down"),c.addClass("ui-refresh"))},_createBtn:function(a){return this._options["$"+a+"Elem"].html('<span class="ui-refresh-icon"></span><span class="ui-refresh-label">\u52a0\u8f7d\u66f4\u591a</span>'),this},_setStyle:function(a,c){var d=this,e=b.Event("statechange");return d.trigger(e,d._options["$"+a+"Elem"],c,a),e.defaultPrevented?d:d._changeStyle(a,c)},_changeStyle:function(a,b){var c=this._options,d=c.refreshInfo[a];switch(b){case"loaded":d.$label.html(d.text),d.$icon.removeClass(),c._actDir="";break;case"loading":d.$label.html("\u52a0\u8f7d\u4e2d..."),d.$icon.addClass("ui-loading"),c._actDir=a;break;case"disable":d.$label.html("\u6ca1\u6709\u66f4\u591a\u5185\u5bb9\u4e86")}return this},_loadingAction:function(a,c){var d=this,e=d._options,f=e.load;return b.isFunction(f)&&f.call(d,a,c),d._status(a,!1),d},afterDataLoading:function(a){var b=this,a=a||b._options._actDir;return b._setStyle(a,"loaded"),b._status(a,!0),b},_status:function(a,b){var d=this._options;return b===c?d["_"+a+"Open"]:d["_"+a+"Open"]=!!b},_setable:function(a,c,d){var e=this,f=e._options,g=c?[c]:["up","down"];return b.each(g,function(b,c){var g=f["$"+c+"Elem"];g.length&&(a?g.show():d?g.hide():e._setStyle(c,"disable"),e._status(c,a))}),e},disable:function(a,b){return this._setable(!1,a,b)},enable:function(a){return this._setable(!0,a)}})}(gmu,gmu.$);
//!function(a,b){a.Refresh.register("iscroll",{_init:function(){var a=this,c=a._options,d=a.$el,e=d.height();b.extend(c,{useTransition:!0,speedScale:1,topOffset:c.$upElem?c.$upElem.height():0}),c.threshold=c.threshold||5,d.wrapAll(b('<div class="ui-refresh-wrapper"></div>').height(e)).css("height","auto"),a.on("ready",function(){a._loadIscroll()})},_changeStyle:function(a,b){var c=this,d=c._options,e=d.refreshInfo[a];switch(c.origin(a,b),b){case"loaded":e.$icon.addClass("ui-refresh-icon");break;case"beforeload":e.$label.html("\u677e\u5f00\u7acb\u5373\u52a0\u8f7d"),e.$icon.addClass("ui-refresh-flip");break;case"loading":e.$icon.removeClass().addClass("ui-loading")}return c},_loadIscroll:function(){var a=this,c=a._options,d=c.threshold;c.iScroll=new iScroll(a.$el.parent().get(0),c.iScrollOpts=b.extend({useTransition:c.useTransition,speedScale:c.speedScale,topOffset:c.topOffset},c.iScrollOpts,{onScrollStart:function(b){a.trigger("scrollstart",b)},onScrollMove:function(){var b=c.$upElem&&c.$upElem.length,e=c.$downElem&&c.$downElem.length;return function(f){var g=c._upRefreshed,h=c._downRefreshed,i=a._status("up"),j=a._status("down");b&&!i||e&&!j||this.maxScrollY>=0||(j&&e&&!h&&this.y<this.maxScrollY-d?a._setMoveState("down","beforeload","pull"):i&&b&&!g&&this.y>d?(a._setMoveState("up","beforeload","pull"),this.minScrollY=0):j&&h&&this.y>this.maxScrollY+d?a._setMoveState("down","loaded","restore"):i&&g&&this.y<d&&(a._setMoveState("up","loaded","restore"),this.minScrollY=-c.topOffset),a.trigger("scrollmove",f))}}(),onScrollEnd:function(b){var d=c._actDir;d&&a._status(d)&&(a._setStyle(d,"loading"),a._loadingAction(d,"pull")),a.trigger("scrollend",b)}}))},_setMoveState:function(a,b,c){var d=this,e=d._options;return d._setStyle(a,b),e["_"+a+"Refreshed"]="pull"==c,e._actDir="pull"==c?a:"",d},afterDataLoading:function(a){var b=this,c=b._options,a=a||c._actDir;return c.iScroll.refresh(),c["_"+a+"Refreshed"]=!1,b.origin(a)}})}(gmu,gmu.$);
//!function(a,b){a.Refresh.register("lite",{_init:function(){var a=this,c=a._options,d=a.$el;return c.seamless&&b(document).on("scrollStop",b.proxy(a._eventHandler,a)),d.on("touchstart touchmove touchend touchcancel",b.proxy(a._eventHandler,a)),c.wrapperH=d.height(),c.wrapperTop=d.offset().top,c._win=window,c._body=document.body,a},_changeStyle:function(a,b){var c=this,d=c._options.refreshInfo[a];return"beforeload"==b&&(d.$icon.removeClass("ui-loading"),d.$label.html("\u677e\u5f00\u7acb\u5373\u52a0\u8f7d")),c.origin(a,b)},_startHandler:function(a){this._options._startY=a.touches[0].pageY},_moveHandler:function(a){var b=this,c=b._options,d=c._startY,e=d-a.touches[0].pageY,f=c._win.innerHeight,g=c.threshold||(c.wrapperH<f?c.wrapperH/2+c.wrapperTop||0:f/2);if(b._status("down")&&!(0>e))return!c._refreshing&&d>=c._body.scrollHeight-f+g&&e>10&&(b._setStyle("down","beforeload"),c._refreshing=!0),b},_endHandler:function(){var a=this,b=a._options;return a._setStyle("down","loading"),a._loadingAction("down","pull"),b._refreshing=!1,a},_eventHandler:function(a){var b=this,c=b._options;switch(a.type){case"touchstart":b._startHandler(a);break;case"touchmove":clearTimeout(c._endTimer),c._endTimer=setTimeout(function(){b._endHandler()},300),b._moveHandler(a);break;case"touchend":case"touchcancel":clearTimeout(c._endTimer),c._refreshing&&b._endHandler();break;case"scrollStop":!c._refreshing&&c._win.pageYOffset>=c._body.scrollHeight-c._win.innerHeight+(c.threshold||-1)&&b._endHandler()}return b}})}(gmu,gmu.$);
//!function(a,b){a.Refresh.register("iOS5",{_init:function(){var a=this,c=a._options,d=a.$el;d.css({overflow:"scroll","-webkit-overflow-scrolling":"touch"}),c.topOffset=c.$upElem?c.$upElem.height():0,c.iScroll=a._getiScroll(),d.get(0).scrollTop=c.topOffset,d.on("touchstart touchmove touchend",b.proxy(a._eventHandler,a))},_changeStyle:function(a,b){var c=this,d=c._options,e=d.refreshInfo[a];switch(c.origin(a,b),b){case"loaded":e.$icon.addClass("ui-refresh-icon"),d._actDir="";break;case"beforeload":e.$label.html("\u677e\u5f00\u7acb\u5373\u52a0\u8f7d"),e.$icon.addClass("ui-refresh-flip");break;case"loading":e.$icon.removeClass().addClass("ui-loading")}return c},_scrollStart:function(a){var b=this,c=b._options,d=c.topOffset,e=c.$upElem,f=b.$el.get(0),g=function(){clearTimeout(c.topOffsetTimer),e&&e.length&&f.scrollTop<=d&&!c._upRefreshed&&(f.scrollTop=d)};return b.trigger("scrollstart",a),b._enableScroll()._bindScrollStop(f,g),c.maxScrollY=f.offsetHeight-f.scrollHeight,c._scrollFn=g,b},_scrollMove:function(){var a=this,b=a._options,c=b.$upElem&&b.$upElem.length,d=b.$downElem&&b.$downElem.length,e=a.$el.get(0),f=b.threshold||5;a._scrollMove=function(g){var h=b.maxScrollY,i=e.scrollTop,j=b.lastMoveY||i,k=b._upRefreshed,l=b._downRefreshed,m=a._status("up"),n=a._status("down");if(!(c&&!m||d&&!n))return b.iScroll.deltaY=i-j,n&&d&&!l&&h-f>-i?a._setMoveState("down","beforeload","pull"):n&&d&&l&&-i>h-f&&-i!==h?a._setMoveState("down","loaded","restore"):m&&c&&!k&&-i>f?a._setMoveState("up","beforeload","pull"):m&&c&&k&&f>-i&&i&&a._setMoveState("up","loaded","restore"),b.lastMoveY=i,b._moved=!0,a.trigger("scrollmove",g,i,i-j)},a._scrollMove.apply(a,arguments)},_scrollEnd:function(a){var c=this,d=c._options,e=c.$el.get(0),f=d.topOffset,g=d._actDir,h=d._restoreDir;return("up"==h||e.scrollTop<=f)&&!g&&d._moved&&(c._options.topOffsetTimer=setTimeout(function(){b(e).off("scroll",d._scrollFn),e.scrollTop=f},800)),g&&c._status(g)&&(c._setStyle(g,"loading"),c._loadingAction(g,"pull")),d._moved=!1,c.trigger("scrollend",a)},_enableScroll:function(){var a=this,b=a.$el.get(0),c=b.scrollTop;return 0>=c&&(b.scrollTop=1),c+b.offsetHeight>=b.scrollHeight&&(b.scrollTop=b.scrollHeight-b.offsetHeight-1),a},_bindScrollStop:function(a,c){var d=this,e=b(a);return e.off("scroll",d._options._scrollFn).on("scroll",b.debounce(100,function(){e.off("scroll",arguments.callee).one("scroll",c)},!1)),d},_getiScroll:function(){var a=this,b=a.$el,c=b[0];return{el:c,deltaY:0,scrollTo:function(a,d,e){e&&(a=c.scrollTop+a),b.css({"-webkit-transition-property":"scrollTop","-webkit-transition-duration":a+"ms"}),c.scrollTop=a},disable:function(c){c&&a.destroy(),b.css("overflow","hidden")},enable:function(){b.css("overflow","scroll")}}},_setMoveState:function(a,b,c){var d=this,e=d._options;return d._setStyle(a,b),e["_"+a+"Refreshed"]="pull"==c,e._actDir="pull"==c?a:"",e._restoreDir="up"==a&&"restore"==c?a:"",d},_eventHandler:function(a){var b=this;switch(a.type){case"touchstart":b._scrollStart(a);break;case"touchmove":b._scrollMove(a);break;case"touchend":b._scrollEnd(a)}},afterDataLoading:function(a){var b=this,c=b._options,a=a||c._actDir;return c["_"+a+"Refreshed"]=!1,"up"==a&&(b.$el.get(0).scrollTop=c.topOffset),b.origin(a)}})}(gmu,gmu.$);