/**
 * @file tabs
 * @import src/widget/tabs/tabs.js,src/widget/tabs/$swipe.js,src/widget/tabs/$ajax.js
 * @module GMU
 */
!function(a,b,c){var d=1,e=function(){return d++},f=/^#(.+)$/;a.define("Tabs",{options:{active:0,items:null,transition:"slide"},template:{nav:'<ul class="ui-tabs-nav"><% var item; for(var i=0, length=items.length; i<length; i++) { item=items[i]; %><li<% if(i==active){ %> class="ui-state-active"<% } %>><a href="javascript:;"><%=item.title%></a></li><% } %></ul>',content:'<div class="ui-viewport ui-tabs-content"><% var item; for(var i=0, length=items.length; i<length; i++) { item=items[i]; %><div<% if(item.id){ %> id="<%=item.id%>"<% } %> class="ui-tabs-panel <%=transition%><% if(i==active){ %> ui-state-active<% } %>"><%=item.content%></div><% } %></div>'},_init:function(){var d,a=this,c=a._options,e=b.proxy(a._eventHandler,a);a.on("ready",function(){d=a.$el,d.addClass("ui-tabs"),c._nav.on("tap",e).children().highlight("ui-state-hover")}),b(window).on("ortchange",e)},_create:function(){var a=this,c=a._options;a._options.setup&&a.$el.children().length>0?a._prepareDom("setup",c):(c.setup=!1,a.$el=a.$el||b("<div></div>"),a._prepareDom("create",c))},_prepareDom:function(a,c){var i,j,k,l,d=this,h=d.$el;switch(a){case"setup":if(c._nav=d._findElement("ul").first(),c._nav){c._content=d._findElement("div.ui-tabs-content"),c._content=(c._content&&c._content.first()||b("<div></div>").appendTo(h)).addClass("ui-viewport ui-tabs-content"),i=[],c._nav.addClass("ui-tabs-nav").children().each(function(){var h,j,a=d._findElement("a",this),g=a?a.attr("href"):b(this).attr("data-url");h=f.test(g)?RegExp.$1:"tabs_"+e(),(j=d._findElement("#"+h)||b('<div id="'+h+'"></div>')).addClass("ui-tabs-panel"+(c.transition?" "+c.transition:"")).appendTo(c._content),i.push({id:h,href:g,title:a?a.attr("href","javascript:;").text():b(this).text(),content:j})}),c.items=i,c.active=Math.max(0,Math.min(i.length-1,c.active||b(".ui-state-active",c._nav).index()||0)),d._getPanel().add(c._nav.children().eq(c.active)).addClass("ui-state-active");break}default:i=c.items=c.items||[],j=[],k=[],c.active=Math.max(0,Math.min(i.length-1,c.active)),b.each(i,function(a,b){l="tabs_"+e(),j.push({href:b.href||"#"+l,title:b.title}),k.push({content:b.content||"",id:l}),i[a].id=l}),c._nav=b(this.tpl2html("nav",{items:j,active:c.active})).prependTo(h),c._content=b(this.tpl2html("content",{items:k,active:c.active,transition:c.transition})).appendTo(h),c.container=c.container||(h.parent().length?null:"body")}c.container&&h.appendTo(c.container),d._fitToContent(d._getPanel())},_getPanel:function(a){var d=this._options;return b("#"+d.items[a===c?d.active:a].id)},_findElement:function(a,c){var d=b(c||this.$el).find(a);return d.length?d:null},_eventHandler:function(a){var c,d=this._options;switch(a.type){case"ortchange":this.refresh();break;default:(c=b(a.target).closest("li",d._nav.get(0)))&&c.length&&(a.preventDefault(),this.switchTo(c.index()))}},_fitToContent:function(a){var b=this._options,d=b._content;return b._plus===c&&(b._plus=parseFloat(d.css("border-top-width"))+parseFloat(d.css("border-bottom-width"))),d.height(a.height()+b._plus),this},switchTo:function(c){var g,h,i,j,k,d=this,e=d._options,f=e.items;if(!e._buzy&&e.active!=(c=Math.max(0,Math.min(f.length-1,c)))){if(h=b.extend({},f[c]),h.div=d._getPanel(c),h.index=c,i=b.extend({},f[e.active]),i.div=d._getPanel(),i.index=e.active,g=a.Event("beforeActivate"),d.trigger(g,h,i),g.isDefaultPrevented())return d;e._content.children().removeClass("ui-state-active"),h.div.addClass("ui-state-active"),e._nav.children().removeClass("ui-state-active").eq(h.index).addClass("ui-state-active"),e.transition&&(e._buzy=!0,k=b.fx.animationEnd+".tabs",j=c>e.active?"":" reverse",e._content.addClass("ui-viewport-transitioning"),i.div.addClass("out"+j),h.div.addClass("in"+j).on(k,function(a){a.target==a.currentTarget&&(h.div.off(k,arguments.callee),e._buzy=!1,i.div.removeClass("out reverse"),h.div.removeClass("in reverse"),e._content.removeClass("ui-viewport-transitioning"),d.trigger("animateComplete",h,i),d._fitToContent(h.div))})),e.active=c,d.trigger("activate",h,i),e.transition||d._fitToContent(h.div)}return d},refresh:function(){return this._fitToContent(this._getPanel())},destroy:function(){var a=this._options,b=this._eventHandler;return a._nav.off("tap",b).children().highlight(),a.swipe&&a._content.off("swipeLeft swipeRight",b),a.setup||this.$el.remove(),this.$super("destroy")}})}(gmu,gmu.$);
!function(a,b){function j(){a(document).on("touchstart.tabs",function(g){var j,k,h=g.touches?g.touches[0]:g;j={x:h.clientX,y:h.clientY,time:Date.now(),el:a(g.target)},a(document).on("touchmove.tabs",function(b){var d,c=b.touches?b.touches[0]:b;j&&(k={x:c.clientX,y:c.clientY,time:Date.now()},(d=Math.abs(j.x-k.x))>f||d>Math.abs(j.y-k.y)?i(b.target)&&b.preventDefault():a(document).off("touchmove.tabs touchend.tabs"))}).one("touchend.tabs",function(){a(document).off("touchmove.tabs"),j&&k&&k.time-j.time<c&&Math.abs(j.x-k.x)>d&&Math.abs(j.y-k.y)<e&&j.el.trigger(j.x>k.x?"tabsSwipeLeft":"tabsSwipeRight"),j=k=b})})}var c=1e3,d=30,e=70,f=30,g=[],h=!1,i=function(b){for(var c=g.length;c--;)if(a.contains(g[c],b))return!0;return!1};gmu.Tabs.register("swipe",{_init:function(){var b=this._options;this.on("ready",function(){g.push(b._content.get(0)),h=h||(j(),!0),this.$el.on("tabsSwipeLeft tabsSwipeRight",a.proxy(this._eventHandler,this))})},_eventHandler:function(a){var d,e,c=this._options;switch(a.type){case"tabsSwipeLeft":case"tabsSwipeRight":d=c.items,"tabsSwipeLeft"==a.type&&c.active<d.length-1?e=c.active+1:"tabsSwipeRight"==a.type&&c.active>0&&(e=c.active-1),e!==b&&(a.stopPropagation(),this.switchTo(e));break;default:return this.origin(a)}},destroy:function(){var c,b=this._options;return~(c=a.inArray(b._content.get(0),g))&&g.splice(c,1),this.$el.off("tabsSwipeLeft tabsSwipeRight",this._eventHandler),g.length||(a(document).off("touchstart.tabs"),h=!1),this.origin()}})}(Zepto);
!function(a){var c=/^#.+$/,d={},e={loading:'<div class="ui-loading">Loading</div>',error:'<p class="ui-load-error">\u5185\u5bb9\u52a0\u8f7d\u5931\u8d25!</p>'};gmu.Tabs.register("ajax",{_init:function(){var b,d,e,a=this._options;this.on("ready",function(){for(b=a.items,d=0,e=b.length;e>d;d++)b[d].href&&!c.test(b[d].href)&&(b[d].isAjax=!0);this.on("activate",this._onActivate),b[a.active].isAjax&&this.load(a.active)})},destroy:function(){return this.off("activate",this._onActivate),this.xhr&&this.xhr.abort(),this.origin()},_fitToContent:function(a){var b=this._options;return b._fitLock?void 0:this.origin(a)},_onActivate:function(a,b){b.isAjax&&this.load(b.index)},load:function(b,c){var i,j,k,f=this,g=f._options,h=g.items;return 0>b||b>h.length-1||!(i=h[b])||!i.isAjax||(j=f._getPanel(b)).text()&&!c&&d[b]?this:((k=f.xhr)&&setTimeout(function(){k.abort()},400),g._loadingTimer=setTimeout(function(){j.html(e.loading)},50),g._fitLock=!0,f.xhr=a.ajax(a.extend(g.ajax||{},{url:i.href,context:f.$el.get(0),beforeSend:function(a,b){var c=gmu.Event("beforeLoad");return f.trigger(c,a,b),c.isDefaultPrevented()?!1:void 0},success:function(a,c){var e=gmu.Event("beforeRender");clearTimeout(g._loadingTimer),f.trigger(e,a,j,b,c),e.isDefaultPrevented()||j.html(a),g._fitLock=!1,d[b]=!0,f.trigger("load",j),delete f.xhr,f._fitToContent(j)},error:function(){var a=gmu.Event("loadError");clearTimeout(g._loadingTimer),d[b]=!1,f.trigger(a,j),a.isDefaultPrevented()||j.html(e.error),delete f.xhr}})),void 0)}})}(Zepto);
